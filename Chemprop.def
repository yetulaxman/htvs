# This is the modified version of the def file: https://github.com/CSCfi/csc-env-guide/blob/ml-env/docs/apps/ml-env/singularity/pytorch_2.0.0_rocm_ubuntu.def

Bootstrap: docker
From: rocm/dev-ubuntu-22.04:5.4-complete

%labels
  Author Mats Sj√∂berg <mats.sjoberg@csc.fi>
  AUthor Laxman yetukuri <laxman.yetukuri@csc.fi>

%files
  environment.yml /opt/requirements.txt
  chemprop-1.3.1_mod.tar.gz /opt/chemprop-1.3.1_mod.tar.gz

%post
  export DEBIAN_FRONTEND=noninteractive
  export LC_ALL=C

  # Update packages
  apt update
  apt upgrade -y

  apt install -y python-is-python3 git autoconf python3-dev wget git vim libtool openjdk-8-jdk-headless xvfb \
      python3-opengl libaio-dev libxslt1-dev libxml2-dev
  
  pip3 install pip==21.3.1

  pip3 install --no-cache-dir torch torchvision torchaudio torchtext \
       -r /opt/requirements.txt \
       --extra-index-url https://download.pytorch.org/whl/rocm5.4.2
  

 apt install -y rocm-libs rccl

 # Install MPICH
  MPICH_VERSION="3.1.4"
  cd /opt
  wget https://www.mpich.org/static/downloads/${MPICH_VERSION}/mpich-${MPICH_VERSION}.tar.gz
  tar xf mpich-${MPICH_VERSION}.tar.gz
  rm mpich-${MPICH_VERSION}.tar.gz
  cd mpich-${MPICH_VERSION}

  ./configure --disable-fortran --enable-fast=all,O3 --prefix=/usr
  make -j install
  ldconfig
  cd /opt
  rm -rf mpich-3.1.4

  # Install aws-ofi-rccl
  apt install -y libfabric-dev

  cd /opt
  git clone https://github.com/ROCmSoftwarePlatform/aws-ofi-rccl
  cd aws-ofi-rccl
  ./autogen.sh
  ./configure
  make -j && make install
  export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
  cd /opt
  rm -rf aws-ofi-rccl

  apt clean

%environment
  export LC_ALL=C
  export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
  export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
